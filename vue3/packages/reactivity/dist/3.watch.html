<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <div class="app">123</div>
    <script type="module">
      import { computed, reactive, effect, watch } from './reactivity.js'
      const app = document.querySelector('.app')
      const state = reactive({ firstname: 'j', lastname: 'w', age: 30, n: 0 })
      watch(
        state,
        (newVal, oldVal) => {
          console.log(newVal, oldVal)
        },
        {
          immediate: true,
        }
      )
      state.firstname = 'changed'
      const map = {
        1: { timer: 3000, returnVal: 'abc' },
        2: { timer: 2000, returnVal: 'bcd' },
      }
      function getData(newVal) {
        return new Promise((resolve, reject) => {
          setTimeout(() => {
            resolve(map[newVal].returnVal)
          }, map[newVal].timer)
        })
      }
      watch(
        () => state.n,
        async (newVal, oldVal, onCleanup) => {
          let flag = true
          onCleanup(function () {
            flag = false
          })
          let r = await getData(newVal)
          flag && (app.innerHTML = r)
        },
        {
          flush: 'sync',
        }
      )
      state.n++
      state.n++
    </script>
  </body>
</html>
